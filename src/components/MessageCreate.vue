<template>
    <div class="b-container">
        <br><br><br>
                <h1 class="modal-title fs-5" id="jamye-create1">{{ groupName }}Í∞ÄÏ±† ÏûºÏñò ÎÑ£Í∏∞ - Î©îÏÑ∏ÏßÄ ÌÉÄÏûÖ</h1>
                                                    <!-- <div class="modal-body"> -->
                                                            <!-- Í≤åÏãúÍ∏Ä Ï†ïÎ≥¥ ÏûÖÎ†• ÌôîÎ©¥ -->
                <div class="form-group">
                    <input type="text" class="form-control" name="post-title" id="post-title" v-model="postTitle" placeholder="Í≤åÏãúÍ∏Ä Ï†úÎ™©">
                </div>
                    <br>
                    <div class="col-auto">
                        <button type="button" class="btn btn-dark mb-3"  data-bs-toggle="modal" data-bs-target="#nicknameAdd" @click="groupUserList()">ÌîÑÎ°úÌïÑ ÎãâÎÑ§ÏûÑ Ï∂îÍ∞Ä</button>
                    </div>
                    <div class="modal fade" id="nicknameAdd" tabindex="-1" aria-labelledby="nicknameAdd" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="jamye-create1">ÌîÑÎ°úÌïÑ ÎãâÎÑ§ÏûÑ Ï∂îÍ∞Ä</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" @click.stop></button>
                                    </div>
                                    <div class="modal-body">
                                        <input type="text" class="form-control" placeholder="ÏóÖÎ°úÎìúÌï† Î©îÏÑ∏ÏßÄ Ïù¥ÎØ∏ÏßÄÏóê Ï∫°Ï≥êÎêú ÏÉÅÎåÄÏùò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî" v-model="nickname">
                                        <div v-if="userInGroup != 0">
                                            <br>
                                            <button v-if="userInGroupInfo == null" class="btn btn-dark btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            Ìï¥Îãπ ÌöåÏõêÍ≥º Îß§ÌïëÌï† Í∑∏Î£π ÎÇ¥ Ïú†Ï†ÄÍ∞Ä ÏûàÎã§Î©¥ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî
                                            </button>
                                            <button v-else class="btn btn-dark btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                {{ userInGroupInfo.nickname }}
                                            </button>
                                            <div v-for="user in userInGroup" :key="user.groupUserSequence" @click="userInGroupSet(user)">
                                                <ul class="dropdown-menu">
                                                    {{ user.nickname }}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-dark" @click="nicknameAdd">Ï∂îÍ∞Ä</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <div class="nicknames-container">
                        <div
                            v-for="nickname in nicknames"
                            :key="nickname"
                            class="nickname"
                            >
                            {{ nickname }}
                            <span class="remove-button" @click="removeNickname(nickname)">X</span>
                        </div>
                    </div>
                    <div>
                        <div class="row g-2">
                        <div class="col-auto">
                            <input type="file" class="form-control" id="inputPassword2" placeholder="" @change="messageImageChange">
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-dark mb-3" @click="messageListGet">Î©îÏÑ∏ÏßÄ Î≥ÄÌôò</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-dark mb-3" data-bs-toggle="modal" data-bs-target="#imageModal">Ïù¥ÎØ∏ÏßÄ Î≥¥Í¥ÄÌï®</button>
                    <image-box :imageKey="this.imageAddKey" :imageSeq="this.imageAddSeq" :message="this.messageResponse" :imageUidMap = "this.imageMap" @imageMap="handleImageMapUpdate" @messageImage="messageUpdate"></image-box>
                </div>
                <button 
                    v-if="replyMode" 
                    class="btn btn-dark mt-3" 
                    @click="saveReplyTarget">
                    Ï†ÄÏû•
                </button>
                <div class="card card-body">
                    <div class="chat-room">
                        <div v-for="[key, text] in Object.entries(messageResponse)" :key="key">                                                                        
                            <!-- ÎÇ¥ Îß§ÏÑ∏ÏßÄ -->
                            <div v-if="text.myMessage" class="chat-message mt-3">
                                <div v-for="msg in text.message" :key="msg.seq" class="message-container-me"  @click="scrollToMessage(msg)"   :id="'message-' + key + '_' + msg.seq" >
                                    <div class="info-container">
                                        <div class="button-container">
                                            <button class="circle-btn add" @click="addEmptyMessage(key, msg.seq)">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button class="circle-btn up-arrow" @click="moveMessageUp(key, msg.seq)">
                                                <i class="fas fa-arrow-up"></i>
                                            </button>
                                            <button class="circle-btn down-arrow" @click="moveMessageDown(key, msg.seq)">
                                                <i class="fas fa-arrow-down"></i>
                                            </button>
                                            <button class="circle-btn edit" @click="editMessage(key, msg.seq)">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button class="circle-btn delete" @click="removeMessageSeq(key, msg.seq)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button class="circle-btn camera" data-bs-toggle="modal" data-bs-target="#imageModal" @click="selectImageKey(key, msg.seq)">
                                                <i class="fas fa-camera"></i>
                                            </button>
                                        </div>
                                        <span class="send-date">{{ text.sendDate }}</span>
                                    </div>
                                    <p v-if="this.isEditing[key] && this.isEditing[key][msg.seq]" class="from-me" @blur="saveMessage(key, msg)">
                                        <template v-if="msg.isReply">
                                            <input class="reply-header" v-model="msg.replyTo"><br />
                                            <input class="reply-message" v-model="msg.replyMessage">
                                            <hr />
                                        </template>
                                        <input  type="text" v-model="msg.message" class="from-me">
                                        <span class="image-gallery">
                                            <img
                                                v-for="(image, index) in msg.imageKey"
                                                :key="index"
                                                :src="this.imageMap[image]"
                                                class="small-image"
                                                @click="openPreview(image)"
                                                alt="Uploaded Image"
                                            />
                                        </span>
                                    </p>
                                    <p v-else class="from-me">
                                        <input 
                                            v-if="replyMode" 
                                            type="radio" 
                                            name="replySelect" 
                                            :value="key || ',' || msg.seq" 
                                            @input="updateReplySeq(key, msg.seq)"
                                            class="form-check-input mt-1"
                                        />
                                        <template v-if="msg.isReply">
                                            <button 
                                            class="btn btn-sm btn-link me-2" 
                                            @click="toggleReplyMode(msg)"
                                            title="ÎãµÏû• Ïó∞Í≤∞"
                                            >
                                            üîó
                                            </button>
                                            <span class="reply-header">{{ msg.replyTo }}</span><br />
                                            <span class="reply-message">{{ msg.replyMessage }}</span>
                                            <hr />
                                        </template>
                                        {{ msg.message }}
                                        <span class="image-gallery">
                                            <img
                                                v-for="(image, index) in msg.imageKey"
                                                :key="index"
                                                :src="this.imageMap[image]"
                                                class="small-image"
                                                @click="openPreview(image)"
                                                alt="Uploaded Image"
                                            />
                                        </span>
                                    </p>
                                </div>
                            </div>
                            <!-- ÏÉÅÎåÄ Î©îÏÑ∏ÏßÄ -->
                            <div v-else class="chat-message mt-3">
                                <div v-if="userNameMap[text.sendUser] != null">
                                    <div class="send-user">{{ userNameMap[text.sendUser].nickname }}</div>
                                </div>
                                <div v-else class="send-user">{{ text.sendUser }}</div>
                                <div v-for="msg in text.message" :key="msg.seq" class="message-container" :id="'message-' + key + '_' + msg.seq" @click="scrollToMessage(msg)">
                                    <p v-if="this.isEditing[key] && this.isEditing[key][msg.seq]" class="from-them" @blur="saveMessage(key, msg)">
                                        <template v-if="msg.isReply">
                                            <input class="reply-header-them" v-model="msg.replyTo"><br />
                                            <input class="reply-message-them" v-model="msg.replyMessage">
                                            <hr />
                                        </template>
                                        <input  type="text" v-model="msg.message" @blur="saveMessage(key, msg)" class="from-them">
                                        <span class="image-gallery">
                                            <img
                                                v-for="(image, index) in msg.imageKey"
                                                :key="index"
                                                :src="this.imageMap[image]"
                                                class="small-image"
                                                @click="openPreview(image)"
                                                alt="Uploaded Image"
                                            />
                                        </span>
                                    </p>
                                    <p v-else class="from-them">
                                        <template v-if="msg.isReply">
                                            <span class="reply-header-them">{{ msg.replyTo }}</span>
                                            <button 
                                            class="btn btn-sm btn-link me-2" 
                                            @click="toggleReplyMode(msg)"
                                            title="ÎãµÏû• Ïó∞Í≤∞"
                                            >
                                            üîó
                                            </button>
                                            <br />
                                            <span class="reply-message-them">{{ msg.replyMessage }}</span>
                                            <hr />
                                        </template>
                                        <input 
                                            v-if="replyMode" 
                                            type="radio" 
                                            name="replySelect" 
                                            :value="key || ',' || msg.seq" 
                                            @input="updateReplySeq(key, msg.seq)"
                                            class="form-check-input mt-1"
                                        />
                                        {{ msg.message }}
                                        <span class="image-gallery">
                                            <img
                                                v-for="(image, index) in msg.imageKey"
                                                :key="index"
                                                :src="this.imageMap[image]"
                                                class="small-image"
                                                @click="openPreview(image)"
                                                alt="Uploaded Image"
                                            />
                                        </span>
                                    </p>
                                    <div class="info-container-them">
                                        <span class="send-date">{{ text.sendDate }}</span>
                                        <div class="button-container">
                                            <button class="circle-btn add" @click="addEmptyMessage(key, msg.seq)"><i class="fas fa-plus"></i></button>
                                            <button class="circle-btn up-arrow" @click="moveMessageUp(key, msg.seq)"><i class="fas fa-arrow-up"></i></button>
                                            <button class="circle-btn down-arrow" @click="moveMessageDown(key, msg.seq)"><i class="fas fa-arrow-down"></i></button>
                                            <button class="circle-btn edit" @click="editMessage(key, msg.seq)"><i class="fas fa-pencil-alt"></i></button>
                                            <button class="circle-btn delete" @click="removeMessageSeq(key, msg.seq)"><i class="fas fa-trash"></i></button>
                                            <button class="circle-btn camera"  data-bs-toggle="modal" data-bs-target="#imageModal" @click="selectImageKey(key, msg.seq)"><i class="fas fa-camera"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="isPreviewOpen" class="image-preview-overlay" @click="closePreview">
                    <div class="image-preview-container">
                        <img :src="this.imageMap[previewImage]" alt="Preview Image" class="large-image" />
                    </div>
                </div>
                <button class="btn btn-dark btn-block" @click="createPost()">ÏÉùÏÑ±</button>
            </div>
</template>
<script>
import axios from 'axios';
import ImageBox from './ImageBox.vue';

export default {
    components: {
        ImageBox
    },
    data() {
        return {
            groupName: null,
            nickname: null,
            nicknames: new Set,
            name: null,
            messageImage: null,
            isEditing: {},
            postType: null,
            postTitle: null,
            detail: null,
            userInGroup: [],
            userInGroupInfo: null,
            userNameMap: new Map,
            replyMode: false, 
            selectedReplyKey: null, 
            selectedReplySeq: null, 
            replyOriginMessage: null,
            selectedImages: [],
            imageAddKey: null,
            imageAddSeq: null,
            isPreviewOpen: false, // ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÉÅÌÉú
            previewImage: null,   // ÌòÑÏû¨ ÎØ∏Î¶¨Î≥¥Í∏∞ Ïù¥ÎØ∏ÏßÄ.
            imageMap: {},
            messageResponse: {"1":{"sendUser":"Ïù¥ÏÜ°ÏùÄ","sendUserInGroupSeq":null,"message":[{"seq":1,"message":"Ìò∏Îñ°ÎØπÏä§ ÌÜ†Ïä§Ïóê 8Í∞ú Ïù¥ÎßåÏõêÏù∏Îç∞ Í≥µÍµ¨Ìï†"},{"seq":2,"message":"ÏÇ¨Îûå ÏóÜÎÇò"},{"seq":3,"message":"ÌïúÍ∞ú Ïù¥Ï≤úÏò§Î∞±Ïõê"}],"sendDate":"Ïò§ÌõÑ 5:23","myMessage":false,"isReply":false,"replyMessage":null},"2":{"sendUser":null,"sendUserInGroupSeq":null,"message":[{"seq":1,"message":"Ïä¨Ìçº"},{"seq":2,"message":"test"},{"seq":3,"message":"sss"}],"sendDate":"Ïò§ÌõÑ 5:50","myMessage":true,"isReply":false,"replyMessage":null},"3":{"sendUser":null,"sendUserInGroupSeq":null,"message":[{"seq":1,"message":"Í∑ºÎç∞ÏÇ¨ÎèÑÏïàÎ®πÏùÑÎìØ"}],"sendDate":"Ïò§ÌõÑ 5:51","myMessage":true,"isReply":false,"replyMessage":null},"4":{"sendUser":"Ïù¥ÏÜ°ÏùÄ","sendUserInGroupSeq":null,"message":[{"seq":1,"message":"ÎÇú Ìò∏Îñ° Ï¢ãÏïÑÌïòÎãàÍπå Ìï¥Î®πÏùÑÍ±∞Í∞ôÍ∏¥ÌïúÎç∞"},{"seq":2,"message":"8Í∞úÎäî ÎÑò ÎßéÏïÑ"}],"sendDate":"Ïò§ÌõÑ 5:52","myMessage":false,"isReply":false,"replyMessage":null},"5":{"sendUser":null,"sendUserInGroupSeq":null,"message":[{"seq":1,"message":"ÎßéÍ∏¥ ÌòÄ"}],"sendDate":"Ïò§ÌõÑ 5:54","myMessage":true,"isReply":false,"replyMessage":null},"51":{"sendUser":null,"sendUserInGroupSeq":null,"message":[{"seq":1,"message":"https://x.com/samnonnna/status/","isReply":false,"replyMessage":null,"replyTo":null},{"seq":2,"message":"1852559442287771995?","isReply":false,"replyMessage":null,"replyTo":null},{"seq":3,"message":"t=stWEBNSIS42UHri6SpAfwQ&s=32","isReply":false,"replyMessage":null,"replyTo":null},{"seq":4,"message":"1 ÏïÑ Í∞ú ÏõÉÍπÄ","isReply":false,"replyMessage":null,"replyTo":null}],"sendDate":"Ïò§ÌõÑ 4:08","myMessage":true},"52":{"sendUser":"Ïù¥ÏÜ°ÏùÄ","sendUserInGroupSeq":null,"message":[{"seq":1,"message":"Ïò§Ïö¥ÏôÑ","isReply":true,"replyMessage":"„Öá„Öá„Öá„ÖáÏïÑÎãà„Öè„Öá","replyTo":"~~ÏóêÍ≤å ÎãµÏû•"}],"sendDate":"Ïò§ÌõÑ 4:08","myMessage":false},"53":{"sendUser":null,"sendUserInGroupSeq":null,"message":[{"seq":1,"message":"Ïß± Ïù¥Îã§","isReply":true,"replyMessage":"ÏïàÎê® ÏßëÏ£ºÏù∏ ÌïúÌÖå ÏòÅÏÉÅ Î≥¥ÎÇ¥","replyTo":"Ïù¥ÏÜ° ÏùÄ ÏóêÍ≤å ÎãµÏû•"}],"sendDate":null,"myMessage":true},"54":{"sendUser":null,"sendUserInGroupSeq":null,"message":[],"sendDate":null,"myMessage":true},"55":{"sendUser":null,"sendUserInGroupSeq":null,"message":[{"seq":1,"message":"Î≠êÎùºÍ≥† Î∂àÎü¨","isReply":false,"replyMessage":null,"replyTo":null}],"sendDate":null,"myMessage":true},"56":{"sendUser":null,"sendUserInGroupSeq":null,"message":[{"seq":1,"message":"ÏÇºÎπ† ?","isReply":false,"replyMessage":null,"replyTo":null}],"sendDate":"Ïò§ÌõÑ 4:08","myMessage":true}}
        }
    },
    props: {
        seq: Number,
        isLogin: {
            type: Boolean,
            required: true
        }
    },
    created() {
        var group = this.$cookies.get("group")
        if(!this.isLogin) {
            alert("Î°úÍ∑∏Ïù∏ ÌõÑ Í≤åÏãúÍ∏Ä ÏûëÏÑ±Ïù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.")
            this.$router.push("/login")
        } else if(group == null) {
            alert("Î©îÏÑ∏ÏßÄÎ•º ÏûëÏÑ±Ìï† Í∑∏Î£πÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî")
            this.$router.push("/")
        } else {
            this.groupName = group.name
        }
    },
    methods: {
        nicknameAdd() {
            if(this.nickname == null) {
                alert("ÌîÑÎ°úÌïÑ Ïù¥Î¶ÑÏùÑ Î®ºÏ†Ä ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî")
                return
            }
            this.nicknames.add(this.nickname)
            this.userNameMap[this.nickname] = this.userInGroupInfo
            console.log(this.userNameMap)
            this.nickname = null
            this.userInGroupInfo = null 
        },
        removeNickname(nickname) {
            this.nicknames.delete(nickname);
            this.nicknames = new Set([...this.nicknames]);
        },
        messageListGet() {
            if(this.messageImage == null) {
                alert("Î©îÏÑ∏ÏßÄ Î≥ÄÌôòÌï† Ïù¥ÎØ∏ÏßÄÎ•º Ï≤®Î∂ÄÌï¥Ï£ºÏÑ∏Ïöî")
                return
            }
            const formdata = new FormData()
            formdata.append("image", this.messageImage)
            const nicknameParam = [...this.nicknames].join(',');
            axios.post("/api/post/message-text?sendUser=" + nicknameParam, formdata, {
                headers: {
                    Authorization: `Bearer `+this.$cookies.get('accessToken')
                }
            })
            .then(r => {
                console.log(this.messageResponse)
                if(this.messageResponse !=null && Object.keys(this.messageResponse).length != 0) {
                    const maxKey = Math.max(...Object.keys(this.messageResponse).map(Number));
                    for(let [id, value] of Object.entries(r.data.data)) {
                        console.log(id)
                        this.messageResponse[Number(maxKey) + Number(id)] = value
                    }
                } else {
                    console.log(r.data.data)
                    this.messageResponse = r.data.data
                }
                
            })
            .catch(e => {
                alert(e.data.message)
            })
        },
        messageImageChange(event){
            const imgbox = this.$refs.imgbox //imgbox refÎ•º Í∞ÄÏßÑ div
            if(event.target.files && event.target.files[0]){ //ÌååÏùºÏûàÎäîÏßÄ Í≤ÄÏÇ¨
                this.messageImage = event.target.files[0]
            }else{
                imgbox.style.backgroundImage = ""
            }
            
        },
        editMessage(key, seq) {
            if (!this.isEditing[key]) {
                this.isEditing[key] = {}; 
            }
            if(this.isEditing[key][seq]) {
                this.isEditing[key][seq] = false; 
            } else {
                this.isEditing[key][seq] = true; 
            }
            console.log(this.imageMap)
            
        },
        saveMessage(key, msg) {
            console.log(msg)
            this.isEditing[key] = false;
        },
        removeMessageSeq(key, msgSeq) {
            if (this.messageResponse[key] && Array.isArray(this.messageResponse[key].message)) {
                this.messageResponse[key].message = this.messageResponse[key].message.filter(
                    (msg) => msg.seq !== msgSeq
                );
                this.messageResponse[key].message.forEach(it => {
                    if(it.seq > msgSeq) {
                        it.seq = it.seq - 1
                    }
                });
                if (!this.isEditing[key]) {
                    this.isEditing[key] = {}; 
                }
                this.isEditing[key][msgSeq] = false 
                }
                var tempKey = 1
                var tempMap = new Map
                for(let [index, value] of Object.entries(this.messageResponse)) {
                    console.log(value)
                    if(value.message.length != 0) {
                        console.log(index)
                        tempMap[tempKey++] = value
                    }
                }
                this.messageResponse = tempMap
        },
        addEmptyMessage(key, msgSeq) {
            if (this.messageResponse[key] && Array.isArray(this.messageResponse[key].message)) {
                this.messageResponse[key].message.forEach(it => {
                    if(it.seq > msgSeq) {
                        it.seq = it.seq + 1
                    }
                });
                this.messageResponse[key].message.push({
                    seq: msgSeq + 1,
                    message: "."
                });    
                this.messageResponse[key].message.sort((a, b) => a.seq - b.seq);
                
                if(this.isEditing[key, msgSeq + 1]) {
                    console.log(true)
                    this.editMessage(key, msgSeq + 1 + 1)
                }
                this.editMessage(key, msgSeq + 1)
            }    
        },
        moveMessageUp(key, seq) {
            if(key==1 && seq ==1) {
                return
            }
            const messageArray = this.messageResponse[key].message;
            console.log(key + "," + seq)
            // seqÍ∞Ä 1Ïù∏ Í≤ΩÏö∞ ÏÉàÎ°úÏö¥ keyÎ°ú Í∞ùÏ≤¥ ÏÉùÏÑ±
            if (seq === 1) {
                var messageText = JSON.parse(JSON.stringify(this.messageResponse[key].message.filter(msg => msg.seq == seq)));
                this.messageResponse[key].message = this.messageResponse[key].message.filter(msg => msg.seq != seq)
                var orderSeq = 1
                if(this.messageResponse[key].message.length != 0) {
                    this.messageResponse[key].message.forEach(msg => {
                        msg.seq = orderSeq++
                    })
                }
                
                var messageNewObject = JSON.parse(JSON.stringify(this.messageResponse[key]));
                
                var preMessageCut = JSON.parse(JSON.stringify(this.messageResponse[key-1]))
                if(preMessageCut.sendUser == messageText.sendUser) {
                    const maxSeq = preMessageCut.message.reduce((max, msg) => {
                        return msg.seq > max ? msg.seq : max;
                    }, 0);

                    var maxMsg = preMessageCut.message.pop()
                    preMessageCut.message.push({
                        seq: maxSeq,
                        message: messageText.pop().message
                    })
                    preMessageCut.message.push({
                        seq: maxSeq + 1,
                        message: maxMsg.message
                    })
                    this.messageResponse[key - 1].message = []
                } else {
                    preMessageCut.message = [preMessageCut.message.pop()]
                    messageNewObject.message = messageText
                    messageNewObject.sendDate = null
                }
                const lastSeq = preMessageCut.message.reduce((max, msg) => {
                    return msg.seq > max ? msg.seq : max;
                    }, 0);
                this.messageResponse[key - 1].message = this.messageResponse[key - 1].message.filter(msg => msg.seq != lastSeq)

                var tempMap = new Map
                var tempKey = 1
                for(let [id, value] of Object.entries(this.messageResponse)) {
                    if(id == key) {
                        if(messageNewObject.message.length != 0) {
                            tempMap[tempKey++] = messageNewObject
                        }
                        
                        if(preMessageCut.message.length != 0) {
                            tempMap[tempKey++] = preMessageCut
                        }
                        
                        if(value.message.length != 0) {
                            tempMap[tempKey++] = value
                        }

                    } else if(value.message.length != 0){
                        tempMap[tempKey++] = value
                    }
                }
                console.log("result1:" + JSON.stringify(tempMap))
                
                var tempMapUser = new Map
                var preUser = null
                tempKey = 1
                for(let [id, value] of Object.entries(tempMap)) {
                    console.log(value)
                    if(id == 1) {
                        preUser = value.sendUser
                        tempMapUser[tempKey++] = value
                        continue
                    }
                    if (value.sendUser == preUser) {
                        console.log(preUser)
                        console.log(value.sendUser)
                        var maxNum = tempMapUser[tempKey - 1].message.reduce((max, msg) => {
                            return msg.seq > max ? msg.seq : max;
                        }, 0);
                        value.message.forEach(msg => tempMapUser[tempKey - 1].message.push({
                            seq: ++maxNum,
                            message: msg.message
                        }))
                    } else {
                        tempMapUser[tempKey++] = value
                    }
                    preUser = value.sendUser
                    console.log("result2:" + JSON.stringify(tempMapUser))
                }
                console.log("result2-1:" + JSON.stringify(tempMapUser))
                this.messageResponse = JSON.parse(JSON.stringify(tempMapUser))

                console.log("result3:" + JSON.stringify(this.messageResponse))
            } else {
                // seqÍ∞Ä 1Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ Î∞∞Ïó¥ ÎÇ¥ÏóêÏÑú ÏàúÏÑú Î≥ÄÍ≤Ω
                const index = messageArray.findIndex(msg => msg.seq === seq);
                if (index > 0) {
                // ÌòÑÏû¨ Î©îÏãúÏßÄÎ•º Ìïú Îã®Í≥Ñ ÏúÑÎ°ú Ïò¨Î¶º
                [messageArray[index - 1], messageArray[index]] = [messageArray[index], messageArray[index - 1]];
                
                // seq Í∞íÏùÑ ÏóÖÎç∞Ïù¥Ìä∏
                messageArray[index - 1].seq -= 1;
                messageArray[index].seq += 1;
                }
            }

        },
        moveMessageDown(key, seq) {
            const maxKey = Math.max(...Object.keys(this.messageResponse).map(Number));
            const maxSeq = this.messageResponse[maxKey].message.reduce((max, msg) => {
                        return msg.seq > max ? msg.seq : max;
                    }, 0);

            if(key==maxKey && seq ==maxSeq) {
                return
            }


            const messageArray = this.messageResponse[key].message;
            const editMapMaxSeq = messageArray.reduce((max, msg) => {
                        return msg.seq > max ? msg.seq : max;
                    }, 0);
            console.log(key + "," + seq)

            if (seq === editMapMaxSeq) {
                var messageText = JSON.parse(JSON.stringify(this.messageResponse[key]))
                messageText.message = []
                messageText.message.push({
                    seq: 1,
                    message: this.messageResponse[key].message.pop().message
                })
                console.log("1:" + JSON.stringify(messageText))
                console.log(this.messageResponse[key])
                var nextKey = Number(key) + 1
                var upMessage = JSON.parse(JSON.stringify(this.messageResponse[nextKey]))
                upMessage.message = this.messageResponse[nextKey].message.filter(msg => msg.seq == 1)
                console.log("2")
                this.messageResponse[nextKey].message = this.messageResponse[nextKey].message.filter(msg => msg.seq != 1)
                console.log("3")
                var orderSeq = 1
                if(this.messageResponse[nextKey].message.length != 0) {
                    console.log("4")
                    this.messageResponse[nextKey].message.forEach(msg => {
                        msg.seq = orderSeq++
                    })
                }
                console.log("thisCut:" + JSON.stringify(messageText))
                console.log("nextCut:" + JSON.stringify(upMessage))
                console.log("origin:" + JSON.stringify(this.messageResponse[nextKey]))
                var tempMap = new Map
                var tempKey = 1
                for(let [id, value] of Object.entries(this.messageResponse)) {
                    if(id == key) {
                        if(value.message.length != 0) {
                            console.log("origin")
                            tempMap[tempKey++] = value
                        }
                        if(upMessage.message.length != 0) {
                            console.log("up")
                            tempMap[tempKey++] = upMessage
                        }
                        if(messageText.message.length != 0) {
                            console.log("down")
                            tempMap[tempKey++] = messageText
                        }
                    } else if(value.message.length != 0){
                        tempMap[tempKey++] = value
                    }
                }
                console.log("result1:" + JSON.stringify(tempMap))
                var tempMapUser = new Map
                var preUser = null
                tempKey = 1
                for(let [id, value] of Object.entries(tempMap)) {
                    console.log(value)
                    if(id == 1) {
                        preUser = value.sendUser
                        tempMapUser[tempKey++] = value
                        continue
                    }
                    if (value.sendUser == preUser) {
                        console.log(preUser)
                        console.log(value.sendUser)
                        var maxNum = tempMapUser[tempKey - 1].message.reduce((max, msg) => {
                            return msg.seq > max ? msg.seq : max;
                        }, 0);
                        value.message.forEach(msg => tempMapUser[tempKey - 1].message.push({
                            seq: ++maxNum,
                            message: msg.message
                        }))
                    } else {
                        tempMapUser[tempKey++] = value
                    }
                    preUser = value.sendUser
                    console.log("result2:" + JSON.stringify(tempMapUser))
                }
                console.log("result2-1:" + JSON.stringify(tempMapUser))
                this.messageResponse = JSON.parse(JSON.stringify(tempMapUser))

                console.log("result3:" + JSON.stringify(this.messageResponse))
            } else {
                console.log("Î∞∞Ïó¥ ÎÇ¥ Ïù¥Îèô")
                // seqÍ∞Ä ÏµúÎåÄÍ∞íÏù¥ ÏïÑÎãå Í≤ΩÏö∞ Î∞∞Ïó¥ ÎÇ¥ÏóêÏÑú ÏàúÏÑú Î≥ÄÍ≤Ω
                const index = messageArray.findIndex(msg => msg.seq === seq);
                if (index < messageArray.length - 1) {
                    // ÌòÑÏû¨ Î©îÏãúÏßÄÎ•º Ìïú Îã®Í≥Ñ ÏïÑÎûòÎ°ú ÎÇ¥Î¶º
                    [messageArray[index], messageArray[index + 1]] = [messageArray[index + 1], messageArray[index]];

                    // seq Í∞íÏùÑ ÏóÖÎç∞Ïù¥Ìä∏
                    messageArray[index].seq -= 1;
                    messageArray[index + 1].seq += 1;

                }
            }
        },
        createPost() {
            if(this.postTitle == null) {
                alert("Í≤åÏãúÍ∏Ä Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî")
                return
            }
            const formdata = new FormData()
            Object.entries(this.imageMap).forEach(([key, value]) => {
                formdata.append('imageMap[' + key + ']', value);
            });

            const groupSeq = this.$cookies.get("group").groupSequence;
            const data = {
                title: this.postTitle,
                groupSeq: groupSeq,
                content: this.messageResponse
            };

            formdata.append('data', JSON.stringify(data));
            
                axios.post("/api/post/message", formdata, {
                    headers: {
                        Authorization: `Bearer `+this.$cookies.get('accessToken'),
                        "Content-Type": "multipart/form-data"
                    }
                })
            // else 
            //     axios.post("/api/post/board", {
            //             title: this.postTitle,
            //             groupSeq: groupSeq,
            //             content: {
            //                 content: this.detail
            //             }
            //         }, {
            //             headers: {
            //                 Authorization: `Bearer `+this.$cookies.get('accessToken')
            //             }
            //         })
        },
        groupUserList() {
            axios.get("/api/group/users/" + this.$cookies.get("group").groupSequence, {
                headers: {
                    Authorization: `Bearer `+this.$cookies.get('accessToken')
                }
            })
            .then(r => {
                this.userInGroup = r.data.data
            })
        },
        userInGroupSet(userInfo) {
            console.log(userInfo)
            this.userInGroupInfo = userInfo
            console.log(this.userInGroupInfo)
        },
        removeImage() {
        },
        toggleReplyMode(msg) {
            this.replyMode = !this.replyMode;
                if (!this.replyMode) {
                    this.selectedReplyKey = null
                    this.selectedReplySeq = null; // Î™®Îìú ÎπÑÌôúÏÑ±Ìôî Ïãú ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
                    this.replyOriginMessage = null
                } else this.replyOriginMessage = msg
            },
        // ÎãµÏû• ÎåÄÏÉÅ Ï†ÄÏû•
        saveReplyTarget() {
            if(this.selectedReplyKey == null || this.selectedReplySeq == null) {
                alert("Ïó∞Í≤∞Ìï† Î©îÏÑ∏ÏßÄÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî")
                return
            }

            this.replyOriginMessage.replyToKey = this.selectedReplyKey
            this.replyOriginMessage.replyToSeq = this.selectedReplySeq
            
            console.log(this.replyOriginMessage)


            this.replyMode = false;
            this.selectedReplySeq = null;
            this.selectedReplyKey = null;
        },
        scrollToMessage(msg) {
            console.log(msg)
            if(msg.replyToKey == undefined || msg.replyToKey == null || msg.replyToSeq == undefined || msg.replyToSeq == null) {
                return
            }
            const targetMessageId = `message-${msg.replyToKey}_${msg.replyToSeq}`
            console.log(targetMessageId)
            const targetMessage = document.getElementById(targetMessageId)          
            if(targetMessage) {
                targetMessage.scrollIntoView({ behavior: "smooth", block: "start" })
                targetMessage.classList.add('shake');

                // Ïï†ÎãàÎ©îÏù¥ÏÖò Ï¢ÖÎ£å ÌõÑ ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
                setTimeout(() => {
                targetMessage.classList.remove('shake');
                }, 500);
            }  
            
        },
        updateReplySeq(key, seq) {
            this.selectedReplyKey = key
            this.selectedReplySeq = seq
        },
        selectImageKey(key, seq) {
            this.imageAddKey = key
            this.imageAddSeq = seq
            console.log(this.imageMap)
        },
        openPreview(image) {
            this.previewImage = image;
            this.isPreviewOpen = true;
        },
        closePreview() {
            this.isPreviewOpen = false;
            this.previewImage = null;
        },
        handleImageMapUpdate(imageUidMap) {
            console.log("Ï†úÎ∞ú")
            this.imageMap = imageUidMap
        },
        messageUpdate(message) {
            this.messageResponse = message
        }
    },
}
</script>
<style>
@import url("/src/css/message.css");

.nicknames-container {
    display: flex;
}
.image-preview {
  position: relative;
  text-align: center;
}

.image-preview img {
  width: 100%;
  border-radius: 8px;
  height: 120px; /* Í≥†Ï†ïÎêú ÎÜíÏù¥ */
  object-fit: cover;
}

.image-preview .delete-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  background: rgba(255, 0, 0, 0.7);
  color: white;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.image-preview .delete-btn:hover {
  background: rgba(255, 0, 0, 1);
}
/* ÎùºÎîîÏò§ Î≤ÑÌäº Ïª§Ïä§ÌÖÄ Ïä§ÌÉÄÏùº */
.form-check-input {
  accent-color: #fff; /* Í∏∞Î≥∏ Í∞ïÏ°∞ÏÉâ (Î∞∞Í≤ΩÍ≥º ÎèôÏùºÌïòÏßÄ ÏïäÍ≤å ÏÑ§Ï†ï) */
  border: 2px solid #000000 !important; /* ÌååÎûÄÏÉâ ÌÖåÎëêÎ¶¨ */
  width: 18px;
  height: 18px;
  cursor: pointer;
}

/* ÎùºÎîîÏò§ Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉú */
.form-check-input:checked {
  background-color: #000000 !important; /* ÏÑ†ÌÉù Ïãú Î≤ÑÌäº ÎÇ¥Î∂Ä Î∞∞Í≤ΩÏÉâ */
  border-color: #000000 !important;
}

@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  75% { transform: translateX(-5px); }
  100% { transform: translateX(0); }
}

.shake {
  animation: shake 0.5s ease-in-out; /* Ïï†ÎãàÎ©îÏù¥ÏÖò ÏßÄÏÜç ÏãúÍ∞ÑÍ≥º ÌÉÄÏù¥Î∞ç Ìï®Ïàò */
}
.small-image {
  width: 100px; /* ÏõêÌïòÎäî ÌÅ¨Í∏∞Î°ú ÏÑ§Ï†ï */
  height: 100px;
  object-fit: cover;
  cursor: pointer;
  margin: 5px;
  border: 1px solid #ccc;
  border-radius: 5px;
  transition: transform 0.2s ease-in-out;
}
.small-image:hover {
  transform: scale(1.05);
}

/* Ïò§Î≤ÑÎ†àÏù¥ Ïä§ÌÉÄÏùº */
.image-preview-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  cursor: pointer;
}

/* ÎØ∏Î¶¨Î≥¥Í∏∞ Ïª®ÌÖåÏù¥ÎÑà */
.image-preview-container {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  max-width: 90%;
  max-height: 90%;
  overflow: hidden;
}

/* ÌÅ∞ Ïù¥ÎØ∏ÏßÄ Ïä§ÌÉÄÏùº */
.large-image {
  max-width: 70%; /* Ïª®ÌÖåÏù¥ÎÑà ÎÑàÎπÑÏóê ÎßûÏ∂îÍ∏∞ */
  max-height: 70%; /* Ïª®ÌÖåÏù¥ÎÑà ÎÜíÏù¥Ïóê ÎßûÏ∂îÍ∏∞ */
  border-radius: 10px;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
}
</style>